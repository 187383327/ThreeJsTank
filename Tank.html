<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - geometry - cube</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<script src="three.js/build/three.r89.min.js"></script>
		<script src="js/controls/OrbitControls.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		<script>
			"use strict";
			var controls;
			var light, light2, light3;
			var camera, scene, renderer;
			var TankBody, BBhead;

			var gravity = -9.8; // 向上為正
			var velocity = 0;
			var velocityH = 0;
            var heading = 0;
            var barrelHeading=0;
			var lastTime;
            var TankWheelRightFront;
            var TankWheelLeftFront;
            var TankBarrel;                
            var Tank;
            var Shell=[];
            var shellVelocity=0;
            var ShellCount=0;
            var Fire=false;

			var gui, params;
			var guiMe = function() {
			  this.Heading = heading;
			  this.Velocity = velocity;
			  this.addSpeed = 10;
			  this.rotSpeed = 2;
			  this.Stop = function() {
			   	velocity = 0;
			  	this.Velocity = velocity;
			  };
			  this.FollowMe = false;
			};

			init();

			lastTime = Date.now();
			
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 10, 5000 );
				camera.position.y = 500;
				camera.position.z = 400;

				scene = new THREE.Scene();
				
				// create a light
				light = new THREE.DirectionalLight(0xffffff);
				light.position.set(100,200,400);
				scene.add(light);
				light2 = new THREE.DirectionalLight(0xffffff);
				light2.position.set(-400,200,-400);
				scene.add(light2);
				light3 = new THREE.DirectionalLight(0xffffff);
				light3.position.set(100,-400,-400);
				scene.add(light3);

				// add a ground plane
				var texture = new THREE.TextureLoader().load( 'textures/UV_Grid_Sm.jpg' );
				var geometry = new THREE.PlaneGeometry( 1000, 1000 );
				var material = new THREE.MeshPhongMaterial( {map: texture, side: THREE.DoubleSide} );
				var plane = new THREE.Mesh( geometry, material );
				plane.rotation.x = -90 * Math.PI / 180;
				plane.position.y = 0.0;
				scene.add( plane );

				// var axisHelper = new THREE.AxesHelper( 200 );
				// scene.add( axisHelper );

				// texture = new THREE.TextureLoader().load( 'textures/BB8.jpg' );
				geometry = new THREE.BoxGeometry( 80, 20, 80, 1, 1, 1 );
				material = new THREE.MeshPhongMaterial( { color:"#ccff99" } );
				TankBody = new THREE.Mesh( geometry, material );
				TankBody.rotation.y = 90 * Math.PI / 180;
				TankBody.position.y = 25;
                // TankBody.position.z = -800;
                
				// scene.add( TankBody );
                
                texture = new THREE.TextureLoader().load( 'textures/BB8.jpg' );
				
                geometry=new THREE.SphereGeometry(15,32,32);

				var axisHelper = new THREE.AxesHelper( 200 );

                material=new THREE.MeshPhongMaterial({map:texture});
                TankWheelLeftFront=new THREE.Mesh(geometry,material);
                TankWheelLeftFront.rotation.x=90*Math.PI/180;
                TankWheelLeftFront.position.x=48;
                TankWheelLeftFront.position.y=25;
                TankWheelLeftFront.position.z=20;
                TankWheelLeftFront.scale.set(0.5,1,1);
                // scene.add(TankWheelLeftFront);

                // geometry=new THREE.SphereGeometry(15,32,32);
                // material=new THREE.MeshPhongMaterial({color:"#ffffff"});
                TankWheelRightFront=new THREE.Mesh(geometry,material);
                TankWheelRightFront.rotation.x=90*Math.PI/180;
                TankWheelRightFront.position.x=-48;
                TankWheelRightFront.position.y=25;
                TankWheelRightFront.position.z=20;
                TankWheelRightFront.scale.set(0.5,1,1);
                TankWheelLeftFront.add(axisHelper);

                geometry=new THREE.BoxGeometry(20,15,70,1,1,1);
                material=new THREE.MeshPhongMaterial({color:"#ffffff"});
                TankBarrel=new THREE.Mesh(geometry,material);
                TankBarrel.position.y=45;
                TankBarrel.position.z=40;
                // TankBarrel.position.=40;

                // scene.add(TankBarrel);
                

                Tank=new THREE.Group();
                Tank.add(TankBody);
                Tank.add(TankWheelLeftFront);
                Tank.add(TankWheelRightFront);
//----------------------------------------------------
//這邊目前把tank barre從group拿掉，因為不拿掉的話，會相當難以計算
//Barrel的角度
//----------------------------------------------------
                Tank.add(TankBarrel);
                // scene.add(TankBarrel);
                scene.add(Tank);

                
				texture = new THREE.TextureLoader().load( 'textures/BB8-Head.jpg' );
				geometry = new THREE.SphereGeometry( 25, 32, 16 );
				material = new THREE.MeshPhongMaterial( { map: texture } );
				BBhead = new THREE.Mesh( geometry, material );
				BBhead.rotation.y = -90 * Math.PI / 180;
				BBhead.position.y = 100.01;
				// scene.add( BBhead );

				renderer = new THREE.WebGLRenderer();

				// set the background color to gray
				renderer.setClearColor( 0xa0a0a0 );

				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				// let's have the mouse affect the view
				controls = new THREE.OrbitControls( camera, renderer.domElement );

				window.addEventListener( 'resize', onWindowResize, false );

				// add some GUI
				params = new guiMe();
				gui = new dat.GUI();

				gui.add(params, 'Heading').listen();
				gui.add(params, 'Velocity').listen();
				gui.add(params, 'addSpeed', 0, 30);
				gui.add(params, 'rotSpeed', 0, 30);
				gui.add(params, 'Stop');
				gui.add(params, 'FollowMe');
				gui.open();

				window.onkeypress = function( event ) {
			        var key = String.fromCharCode(event.keyCode);
			        var q = new THREE.Quaternion();
			        switch( key ) {
			          case 'w': case 'W':
                        TankBarrel.rotation.x-=0.1;
							break;
			          case 's': case 'S':
                          TankBarrel.rotation.x+=0.1;
                        break;
                     case 'd': case 'D':
                      TankBarrel.rotation.y-=0.1;            
                      barrelHeading	-= 0.1;
                      barrelHeading = barrelHeading % 360;			     
							// Tank.rotateOnWorldAxis ( new THREE.Vector3( 0, 1, 0 ), -params.rotSpeed * Math.PI / 180);            
                        break;
                    case 'a': case 'A':
                          TankBarrel.rotation.y+=0.1;                        
                        break;
			          case ' ':
                            geometry=new THREE.SphereGeometry(5,32,32);
                            material=new THREE.MeshPhongMaterial({color:"#ffffff"});
                            Shell=new THREE.Mesh(geometry,material);
                            
                            Shell.position.x=Tank.children[3].getWorldPosition().x;
                            Shell.position.y=Tank.children[3].getWorldPosition().y;
                            Shell.position.z=Tank.children[3].getWorldPosition().z;

                            // console.log(Tank.children[3].getWorldPosition());
                            // Shell.position.y=TankBarrel.position.y;
                            // Shell.position.z=TankBarrel.position.z;                            
                            scene.add(Shell);
                            shellVelocity=20;
                            Fire=true;
                            ShellCount++
                        // velocityH = 50;
                            break;
                      case "8":
                            velocity += params.addSpeed;
                            params.Velocity = velocity;
                            TankWheelRightFront.rotation.x+=0.3;
							TankWheelLeftFront.rotation.x+=0.3;
                      break;      
                      case "5":
                            velocity -= params.addSpeed;
                            params.Velocity = velocity;
                            TankWheelRightFront.rotation.x-=0.3;
							TankWheelLeftFront.rotation.x-=0.3;
                      break;
                      case "6":
                            heading	-= params.rotSpeed;
			          		heading = heading % 360;			     
							Tank.rotateOnWorldAxis ( new THREE.Vector3( 0, 1, 0 ), -params.rotSpeed * Math.PI / 180);
                            TankWheelRightFront.rotation.x-=0.3;
                            TankWheelLeftFront.rotation.x+=0.3;
                      break;
                      case "4":
                            heading	+= params.rotSpeed;
			          		heading = heading % 360;
							Tank.rotateOnWorldAxis ( new THREE.Vector3( 0, 1, 0 ), params.rotSpeed * Math.PI / 180);
                            TankWheelRightFront.rotation.x+=0.3;
							TankWheelLeftFront.rotation.x-=0.3;                      
                      break;  
			        }
			    };
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			function animate() {
				requestAnimationFrame( animate );

				// Rotate the wheel
				var deltaTime = Date.now() - lastTime;
				lastTime = Date.now();
				var tickV = (velocity*deltaTime/1000.0);
				// Tank.rotateOnAxis ( new THREE.Vector3( 0, 0, 1 ), tickV * Math.PI / 180);
				
				// Move the body & head
				var OldPositionX = Tank.position.x;
				var OldPositionZ = Tank.position.z;
				Tank.position.x += tickV * Math.sin(heading * Math.PI / 180);
				Tank.position.z += tickV * Math.cos(heading * Math.PI / 180);
				if(Tank.position.x > 450 || Tank.position.x < -450)
					Tank.position.x = OldPositionX;
				else
					BBhead.position.x = Tank.position.x;

				if(Tank.position.z > 450 || Tank.position.z < -450)
					Tank.position.z = OldPositionZ;
				else
					BBhead.position.z = Tank.position.z;


				// BBhead.position.y = Tank.position.y + 50;

				// Camera now following the BB8
				if(params.FollowMe){
					camera.position.x = BBhead.position.x;
					camera.position.y = 500;
					camera.position.z = 400+BBhead.position.z;
					camera.lookAt(BBhead.position);
                }
                if(Fire==true)
                {
                    Shell.position.x += shellVelocity * Math.sin(heading * Math.PI / 180);
                    Shell.position.z += shellVelocity * Math.cos(heading * Math.PI / 180);
                    // Shell.position.
                    velocityH += 10*gravity*deltaTime/1000.0;

                    Shell.position.y += 10*velocityH*deltaTime/1000.0;
                    if(Shell.position.y < 5){
                        // Shell.position.y = 0;
                        scene.remove(Shell);
                        velocityH = 0;
                    }
                }



				params.Velocity = velocity;
				params.Heading = heading;

				renderer.render( scene, camera );
				// have the mouse update the view
				controls.update();

			}
		</script>
	</body>
</html>
